from __future__ import annotations

from pathlib import Path

import pytest

from compsyn.config import CompsynConfig
from compsyn.vectors import WordToColorVector
from compsyn.trial import Trial


def arrays_within_n_percent(array_a, array_b, n_percent) -> bool:
    for a, b in zip(array_a, array_b):
        percent_diff = (abs(a - b) / ((a + b) / 2)) * 100
        if percent_diff > n_percent:
            return False
    return True


@pytest.mark.integration
def test_get_wavelet_embedding() -> None:

    CompsynConfig(work_dir=Path(__file__).parent.joinpath("test-assets"),)
    trial = Trial(
        experiment_name="test-downloads",
        trial_id="known-dist",
        hostname="pytester",
        trial_timestamp="testoclock",
    )

    w2cv = WordToColorVector(label="earth", trial=trial)
    w2cv.load_data()
    w2cv.run_analysis()

    # fmt: off
    known_jzazbz_wavelet_embedding =  [0.0007643221761099994, 5.939395123277791e-06, 8.54144491313491e-06, 1.2832133506890386e-05, 2.2208634618436918e-05, 4.323233224567957e-05, 7.402798019029433e-07, 5.64781259981828e-07, 4.5152148686611326e-07, 4.981960159966548e-07, 8.782276381680276e-07, 1.005526883091079e-06, 9.460963497076591e-07, 1.6695033764335676e-06, 1.683814161879127e-06, 3.308663735879236e-06, -5.091798448120244e-05, 1.934064130182378e-06, 2.2873612124385545e-06, 2.911852106990409e-06, 3.6723131415783428e-06, 4.535654625215102e-06, 2.399782772499748e-07, 1.7546553010561183e-07, 1.2219371114952082e-07, 9.771652997869751e-08, 2.3119577008401393e-07, 2.4518183749933087e-07, 2.4462693204441166e-07, 3.6290958860263345e-07, 3.5812593068840215e-07, 5.639482196784229e-07, -0.000204587442567572, 3.907208338205237e-06, 5.2159812184982e-06, 6.603285328310449e-06, 8.695235010236502e-06, 1.2734240954159759e-05, 4.942205578117864e-07, 3.6712040696329495e-07, 2.805884946610604e-07, 2.895924922086124e-07, 5.461257615024806e-07, 6.066255764380912e-07, 5.96736299485201e-07, 8.574583034715033e-07, 8.687269428264699e-07, 1.288311068492476e-06]
    known_rgb_wavelet_embedding = [1.0149459838867188, 0.009396257810294628, 0.013252515345811844, 0.019200582057237625, 0.03169100731611252, 0.0597832128405571, 0.001177848200313747, 0.0008956858655437827, 0.0006961669423617423, 0.0007526640547439456, 0.001356705790385604, 0.0015081641031429172, 0.0014198219869285822, 0.002444450045004487, 0.0024045188911259174, 0.0046163457445800304, 1.1359686851501465, 0.009039577096700668, 0.01293253805488348, 0.019352681934833527, 0.03348885476589203, 0.06518232822418213, 0.0011238295119255781, 0.0008525265147909522, 0.000675839779432863, 0.0007351068779826164, 0.0013168096775189042, 0.0015156366862356663, 0.0014302206691354513, 0.002517778892070055, 0.0025533251464366913, 0.004978210665285587, 1.3184771537780762, 0.008817654103040695, 0.012831225991249084, 0.019689790904521942, 0.034744977951049805, 0.06812523305416107, 0.0010847593657672405, 0.0008324516820721328, 0.0006748223095200956, 0.0007393427076749504, 0.0013635988580062985, 0.001524904859252274, 0.0014678940642625093, 0.0025919084437191486, 0.0026492660399526358, 0.005247402470558882]
    known_grey_wavelet_embedding = [1.1207001209259033, 0.008954653516411781, 0.012728508561849594, 0.01901235617697239, 0.03277358412742615, 0.0636843740940094, 0.0011132140643894672, 0.0008454968919977546, 0.0006713253096677363, 0.0007336997659876943, 0.0013040185440331697, 0.0014946818118914962, 0.001397418323904276, 0.0024632513523101807, 0.002477526431903243, 0.004860419314354658]
    # fmt: on

    print(
        len(w2cv.jzazbz_wavelet_embedding),
        len(w2cv.rgb_wavelet_embedding),
        len(w2cv.grey_wavelet_embedding),
    )

    assert len(w2cv.jzazbz_wavelet_embedding) == len(
        known_jzazbz_wavelet_embedding
    )  # 48 (3 channels)
    assert len(w2cv.rgb_wavelet_embedding) == len(
        known_rgb_wavelet_embedding
    )  # 48 (3 channels)
    assert len(w2cv.grey_wavelet_embedding) == len(
        known_grey_wavelet_embedding
    )  # 16 (1 channel)

    assert arrays_within_n_percent(
        w2cv.jzazbz_wavelet_embedding, known_jzazbz_wavelet_embedding, 1
    )
    assert arrays_within_n_percent(
        w2cv.rgb_wavelet_embedding, known_rgb_wavelet_embedding, 1
    )
    assert arrays_within_n_percent(
        w2cv.grey_wavelet_embedding, known_grey_wavelet_embedding, 1
    )
